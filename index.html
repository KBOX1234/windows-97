<!DOCTYPE html>
<html>
    <head>
        <title>Windows 97</title>
        <link rel="stylesheet" href="C/system/themes/main.css">
    </head>
    <body>

        <div id = "main">

        </div>
        <div id="taskbar">
            <button id="startbutton" onclick="openStartMenu()"><img src="C/system/icons/windows_slanted-1.png">Start</button>
        </div>

        <script src="C/system/boot/kernelFunctions.js"></script>
        <script src="C/system/boot/kernel.js"></script>
        <script src="C/system/lib/api.js"></script>
        <script>

            const baseDirectory = 'C'; // Set the base directory

            async function loadAndPrintFolderStructure(jsonFilePath) {
                try {
                    const response = await fetch(jsonFilePath);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const folderStructure = await response.json();
                    await fetchAndStoreFiles(folderStructure);
                } catch (error) {
                    console.error('Error fetching the JSON file:', error);
                }
            }

            async function fetchAndStoreFiles(structure, currentDir = baseDirectory) {
                for (const name in structure) {
                    const itemPath = `${currentDir}/${name}`; // Use the base directory for paths
                    console.log(itemPath); // Print the name

                    if (structure[name] !== null) { // If it's a directory, call recursively
                        await fetchAndStoreFiles(structure[name], itemPath);
                    } else { // It's a file, fetch its contents
                        try {
                            const fileResponse = await fetch(itemPath);
                            if (!fileResponse.ok) {
                                throw new Error(`Error fetching file: ${itemPath}`);
                            }

                            const fileBlob = await fileResponse.blob();
                            const reader = new FileReader();
                            reader.onloadend = function() {
                                const base64data = reader.result.split(',')[1]; // Get base64 encoded data
                                saveFile(itemPath, base64data); // Call your saveFile function
                            };
                            reader.readAsDataURL(fileBlob); // Read the file as a data URL
                        } catch (error) {
                            console.error('Error fetching the file:', error);
                        }
                    }
                }
            }

            async function startup() {
                
                //iframe comunication
                window.addEventListener('message', async (event) => {
                    // Check the origin of the message for security
                    // if (event.origin !== 'https://your-allowed-origin.com') return;

                    // Log or use the received data
                    console.log('Received data from iframe:', event.data.api);
                    console.log('From iframe ID:', event.data.iframeId);
                    
                    if (event.data.api === "dir") {
                        const sendID = "iframe_" + String(event.data.iframeId);
                        const iframe = document.getElementById(sendID);

                        try {
                            // Wait for the result of the asynchronous function
                            const sendArray = await listFoldersInDirectory(event.data.value);

                            const data = { api: 'dir', value: sendArray, iframeId: event.data.iframeId };
                            console.log("send ID is: " + sendID);

                            // Send the data to the iframe
                            iframe.contentWindow.postMessage(data, '*');
                        } catch (error) {
                            console.error('Error fetching directory data:', error);
                        }
                    }

                    else if (event.data.api === "launch.html") {
                        launch(event.data.value, 'html viewer');
                        console.log("Launching file");
                    }
                    else if (event.data.api === "launch.link") {
                        launch(event.data.value, 'html viewer');
                        console.log("Launching file");
                    }
                });


                openDatabase();

                if(localStorage.getItem("isLoaded") == "true"){
                    console.log("everything is loaded");
                }
                else{
                    localStorage.setItem("isLoaded", "true");
                    console.log("beginning instalation");
                    var diskRecord = "";
                    loadAndPrintFolderStructure('folder_structure.json');
                    saveFile("DiscRecord", diskRecord);

                    loadAndPrintFolderStructure('folder_structure.json');
                }
            }

            // Event listener for DOMContentLoaded
            document.addEventListener("DOMContentLoaded", function() {
                startup();
            });
            

            setInterval(kernel, 1000);
        </script>
    </body>
</html>