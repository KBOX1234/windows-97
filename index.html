<!DOCTYPE html>
<html>
    <head>
        <title>Windows 97</title>
        <link rel="stylesheet" href="C/system/themes/main.css">
    </head>
    <body>

        <div id = "main">

        </div>
        <div id="taskbar">
            <button id="startbutton" onclick="openStartMenu()"><img src="C/system/icons/windows_slanted-1.png">Start</button>
        </div>

        <script src="C/system/boot/kernelFunctions.js"></script>
        <script src="C/system/boot/kernel.js"></script>
        <script>

            const baseDirectory = 'C'; // Set the base directory

            async function loadAndPrintFolderStructure(jsonFilePath) {
                try {
                    const response = await fetch(jsonFilePath);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const folderStructure = await response.json();
                    await fetchAndStoreFiles(folderStructure);
                } catch (error) {
                    console.error('Error fetching the JSON file:', error);
                }
            }

            async function fetchAndStoreFiles(structure, currentDir = baseDirectory) {
                for (const name in structure) {
                    const itemPath = `${currentDir}/${name}`; // Use the base directory for paths
                    console.log(itemPath); // Print the name

                    if (structure[name] !== null) { // If it's a directory, call recursively
                        await fetchAndStoreFiles(structure[name], itemPath);
                    } else { // It's a file, fetch its contents
                        try {
                            const fileResponse = await fetch(itemPath);
                            if (!fileResponse.ok) {
                                throw new Error(`Error fetching file: ${itemPath}`);
                            }

                            const fileBlob = await fileResponse.blob();
                            const reader = new FileReader();
                            reader.onloadend = function() {
                                const base64data = reader.result.split(',')[1]; // Get base64 encoded data
                                saveFile(itemPath, base64data); // Call your saveFile function
                            };
                            reader.readAsDataURL(fileBlob); // Read the file as a data URL
                        } catch (error) {
                            console.error('Error fetching the file:', error);
                        }
                    }
                }
            }

            async function startup() {

                openDatabase();

                if(localStorage.getItem("isLoaded") == "true"){
                    console.log("everything is loaded");
                }
                else{
                    localStorage.setItem("isLoaded", "true");
                    console.log("beginning instalation");
                    var diskRecord = "";
                    loadAndPrintFolderStructure('folder_structure.json');
                    saveFile("DiscRecord", diskRecord);
                    saveFile("/test.js", "dmFyIG15SUQgPSBpZElOQzsNCmlkSU5DKys7DQphcHBpbGNhdGlvbklEc1tteUlEXSA9IHsgbmFtZTogImtlcm5lbCIsIGFwaTogIk5VTEwiLCBkYXRhMTogIm51bGwiLCBkYXRhMjogbnVsbCwgc3RhdHVzOiAicmVhZHkifTsNCmNvbnNvbGUubG9nKG15SUQpOw0KDQphcHBpbGNhdGlvbklEc1tteUlEXS5kYXRhMSA9ICJJdCBkb2VzIHdvcmsiOw0KYXBwaWxjYXRpb25JRHNbbXlJRF0uYXBpID0gInByaW50ZiI7DQphcHBpbGNhdGlvbklEc1tteUlEXS5uYW1lID0gIlRlc3QgQXBwIg0KDQpkZWxheSg1MDApOw0KDQphcHBpbGNhdGlvbklEc1tteUlEXS5hcGkgPSAid2luZG93IjsNCmFwcGlsY2F0aW9uSURzW215SURdLmRhdGExID0gIi90ZXN0Lmh0bWwi");
                    saveFile("/test.html", "PGgxPlRoaXMgaXMgYW4gaDE8L2gxPg0KPGgyPlRoaXMgaXMgYW4gaDI8L2gyPg0KPGgzPlRoaXMgaXMgYW4gaDM8L2gzPg0KPGg0PlRoaXMgaXMgYW4gaDQ8L2g0Pg0KPGg1PlRoaXMgaXMgYW4gaDU8L2g1Pg0KPGg2PlRoaXMgaXMgYW4gaDY8L2g2Pg0KPGEgaHJlZj0iIj5UaGlzIGlzIGEgbGluazwvYT4NCjxwPlRoaXMgaXMgYSBwPC9wPg0KPGJ1dHRvbj5jbGljayBtZSA6KTwvYnV0dG9uPg0K");
                    loadAndPrintFolderStructure('folder_structure.json');
                }
            }

            // Event listener for DOMContentLoaded
            document.addEventListener("DOMContentLoaded", function() {
                startup();
            });
            

            setInterval(kernel, 1000);
        </script>
    </body>
</html>